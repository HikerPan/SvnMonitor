# SVN监控系统 - 开发人员使用手册

## 1. 开发环境搭建

### 1.1 环境要求

#### 开发工具
- **IDE推荐**：VS Code、PyCharm
- **版本控制**：Git
- **Python环境**：Python 3.8+
- **包管理**：pip、virtualenv

#### 开发依赖
```bash
# 核心依赖包
pandas>=1.3.0
openpyxl>=3.0.0
python-dotenv>=0.19.0

# 测试框架
pytest>=6.0.0
pytest-cov>=2.12.0

# 开发工具
black>=21.0.0  # 代码格式化
flake8>=3.9.0  # 代码检查
mypy>=0.910    # 类型检查
```

### 1.2 项目结构

```
svn-monitor/
├── src/                    # 源代码目录
│   ├── svn_monitor.py      # 主程序文件
│   ├── modules/            # 功能模块
│   │   ├── __init__.py
│   │   ├── monitor.py      # 监控模块
│   │   ├── mailer.py       # 邮件模块
│   │   ├── config.py       # 配置模块
│   │   └── logger.py       # 日志模块
│   └── utils/              # 工具函数
│       ├── __init__.py
│       ├── file_utils.py   # 文件操作工具
│       └── svn_utils.py    # SVN操作工具
├── tests/                  # 测试代码
│   ├── __init__.py
│   ├── test_svn_monitor.py # 主程序测试
│   ├── test_monitor.py     # 监控模块测试
│   └── test_mailer.py      # 邮件模块测试
├── config/                 # 配置文件
│   └── svn_monitor_config.xlsx
├── scripts/               # 脚本文件
│   ├── post-commit        # SVN钩子脚本
│   └── run_svn_monitor.bat
├── logs/                  # 日志目录
├── backups/               # 备份目录
└── Doc/                   # 文档目录
```

### 1.3 环境配置

#### 创建虚拟环境
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 环境变量配置
创建 `.env` 文件：
```bash
# 开发环境配置
DEBUG=True
LOG_LEVEL=DEBUG
CONFIG_PATH=config/svn_monitor_config.xlsx
```

## 2. 代码架构

### 2.1 核心模块设计

#### 监控模块 (monitor.py)
```python
class SVNMonitor:
    def __init__(self, config):
        self.config = config
        self.repositories = []
    
    def start_monitoring(self):
        """启动监控"""
        pass
    
    def check_repository(self, repo_config):
        """检查单个仓库"""
        pass
    
    def detect_changes(self, repo_config):
        """检测变更"""
        pass
```

#### 邮件模块 (mailer.py)
```python
class MailSender:
    def __init__(self, mail_config):
        self.config = mail_config
    
    def send_notification(self, commit_info, recipients):
        """发送通知邮件"""
        pass
    
    def create_email_content(self, commit_info):
        """创建邮件内容"""
        pass
```

### 2.2 配置管理

#### 配置类设计
```python
class ConfigManager:
    def __init__(self, config_path):
        self.config_path = config_path
    
    def load_config(self):
        """加载配置文件"""
        pass
    
    def validate_config(self):
        """验证配置有效性"""
        pass
    
    def get_repository_config(self, repo_name):
        """获取仓库配置"""
        pass
```

## 3. 开发规范

### 3.1 代码规范

#### 命名规范
- **变量名**：小写字母，下划线分隔（snake_case）
- **函数名**：小写字母，下划线分隔
- **类名**：首字母大写（CamelCase）
- **常量名**：大写字母，下划线分隔

#### 代码格式
使用 black 进行代码格式化：
```bash
# 格式化代码
black src/
black tests/
```

#### 类型注解
所有函数和方法都需要类型注解：
```python
def check_repository(repo_config: Dict[str, Any]) -> bool:
    """检查仓库状态"""
    pass
```

### 3.2 文档规范

#### 函数文档
```python
def send_notification(commit_info: Dict[str, Any], 
                    recipients: List[str]) -> bool:
    """
    发送SVN提交通知邮件
    
    Args:
        commit_info: 提交信息字典
        recipients: 收件人列表
        
    Returns:
        bool: 发送是否成功
        
    Raises:
        MailSendError: 邮件发送失败时抛出
    """
    pass
```

#### 类文档
```python
class SVNMonitor:
    """
    SVN仓库监控器
    
    Attributes:
        config: 监控配置
        repositories: 监控的仓库列表
        logger: 日志记录器
    """
    
    def __init__(self, config: Dict[str, Any]):
        """初始化监控器"""
        pass
```

## 4. 测试开发

### 4.1 单元测试

#### 测试文件结构
```python
# tests/test_monitor.py
import pytest
from src.modules.monitor import SVNMonitor

class TestSVNMonitor:
    """SVNMonitor测试类"""
    
    @pytest.fixture
    def monitor(self):
        """创建监控器实例"""
        config = {"check_interval": 30}
        return SVNMonitor(config)
    
    def test_start_monitoring(self, monitor):
        """测试启动监控"""
        result = monitor.start_monitoring()
        assert result is True
    
    def test_detect_changes(self, monitor):
        """测试变更检测"""
        repo_config = {"path": "http://test.repo"}
        changes = monitor.detect_changes(repo_config)
        assert isinstance(changes, list)
```

### 4.2 集成测试

#### 测试配置
```python
# tests/conftest.py
import pytest
from src.svn_monitor import SVNMonitorSystem

@pytest.fixture(scope="module")
def test_system():
    """创建测试系统实例"""
    system = SVNMonitorSystem()
    yield system
    system.cleanup()
```

### 4.3 测试运行

#### 运行测试
```bash
# 运行所有测试
pytest

# 运行特定测试
pytest tests/test_monitor.py

# 运行测试并生成覆盖率报告
pytest --cov=src tests/

# 运行测试并输出详细报告
pytest -v
```

## 5. 调试技巧

### 5.1 日志调试

#### 配置调试日志
```python
import logging

# 设置调试级别
logging.basicConfig(level=logging.DEBUG)

# 添加自定义日志
logger = logging.getLogger(__name__)
logger.debug("调试信息: %s", variable)
```

#### 日志级别
- **DEBUG**：详细调试信息
- **INFO**：一般运行信息
- **WARNING**：警告信息
- **ERROR**：错误信息
- **CRITICAL**：严重错误

### 5.2 断点调试

#### 使用pdb调试
```python
import pdb

def problematic_function():
    # 设置断点
    pdb.set_trace()
    # 调试代码
    pass
```

#### VS Code调试配置
创建 `.vscode/launch.json`：
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python: SVN Monitor",
            "type": "python",
            "request": "launch",
            "program": "${workspaceFolder}/src/svn_monitor.py",
            "console": "integratedTerminal",
            "env": {"DEBUG": "true"}
        }
    ]
}
```

## 6. 性能优化

### 6.1 代码优化

#### 避免重复计算
```python
# 不好的写法
for repo in repositories:
    config = load_config()  # 重复加载配置
    check_repository(repo, config)

# 好的写法
config = load_config()  # 一次性加载
for repo in repositories:
    check_repository(repo, config)
```

#### 使用生成器
```python
def get_repositories():
    """使用生成器减少内存占用"""
    for repo_config in config['repositories']:
        yield Repository(repo_config)
```

### 6.2 数据库优化

#### 批量操作
```python
# 批量插入数据
with transaction.atomic():
    for record in records:
        Model.objects.create(**record)
```

## 7. 部署开发

### 7.1 部署环境配置

#### 7.1.1 Windows环境部署配置

**环境要求**
- Python 3.7+
- Git客户端
- SVN客户端
- 邮件服务器访问权限

**部署步骤**
1. **环境准备**
   - 安装Python 3.7+并配置环境变量
   - 安装Git客户端
   - 安装SVN客户端并配置命令行工具
   - 确保网络连接正常

2. **脚本部署**
   - 将项目文件复制到目标目录
   - 安装依赖包：`pip install -r requirements.txt`
   - 配置环境变量（如需要）

3. **自动启动配置**
   - 创建Windows服务或计划任务
   - 配置开机自启动
   - 设置监控间隔和重试机制

#### 7.1.2 Linux环境部署配置

**环境要求**
- Python 3.7+
- Git客户端
- SVN客户端
- 邮件服务器访问权限

**部署步骤**
1. **环境准备**
   - 安装Python 3.7+：`sudo apt-get install python3 python3-pip`
   - 安装Git：`sudo apt-get install git`
   - 安装SVN：`sudo apt-get install subversion`

2. **脚本部署**
   - 将项目文件复制到目标目录
   - 安装依赖包：`pip3 install -r requirements.txt`
   - 设置文件权限：`chmod +x *.py`

3. **自动启动配置**
   - 创建systemd服务文件
   - 配置开机自启动：`sudo systemctl enable svn-monitor`
   - 设置监控间隔和重试机制

### 7.2 SVN钩子部署开发

#### 7.2.1 Windows钩子部署

**钩子创建步骤**
1. **定位SVN仓库**
   - 找到SVN仓库的hooks目录
   - 通常位于：`仓库路径/hooks/`

2. **创建钩子脚本**
   - 复制`post-commit.tmpl`为`post-commit`
   - 编辑钩子脚本，添加监控调用
   - 设置脚本执行权限

3. **权限配置**
   - 确保钩子脚本有执行权限
   - 配置SVN用户权限
   - 测试钩子功能

#### 7.2.2 Linux钩子部署

**钩子创建步骤**
1. **定位SVN仓库**
   - 找到SVN仓库的hooks目录
   - 通常位于：`/var/svn/仓库名/hooks/`

2. **创建钩子脚本**
   - 复制`post-commit.tmpl`为`post-commit`
   - 编辑钩子脚本，添加监控调用
   - 设置脚本执行权限：`chmod +x post-commit`

3. **权限配置**
   - 确保钩子脚本有执行权限
   - 配置SVN用户权限
   - 测试钩子功能

### 7.3 自动化部署脚本开发

#### 7.3.1 部署脚本结构
```python
# deploy.py - 自动化部署脚本
import os
import subprocess
import shutil
from pathlib import Path

class SVNMonitorDeployer:
    def __init__(self, target_dir):
        self.target_dir = Path(target_dir)
        self.config_dir = self.target_dir / "config"
        self.logs_dir = self.target_dir / "logs"
        
    def create_directories(self):
        """创建必要的目录结构"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        self.logs_dir.mkdir(parents=True, exist_ok=True)
        
    def install_dependencies(self):
        """安装Python依赖包"""
        subprocess.run(["pip", "install", "-r", "requirements.txt"], check=True)
        
    def setup_service(self):
        """配置系统服务"""
        # Windows服务配置
        if os.name == 'nt':
            self._setup_windows_service()
        else:
            self._setup_linux_service()
            
    def _setup_windows_service(self):
        """配置Windows服务"""
        # 创建Windows服务配置
        service_config = """
        [Unit]
        Description=SVN Monitor Service
        After=network.target
        
        [Service]
        Type=simple
        ExecStart=python {target_dir}/src/svn_monitor.py
        WorkingDirectory={target_dir}
        Restart=always
        
        [Install]
        WantedBy=multi-user.target
        """.format(target_dir=self.target_dir)
        
        with open("svn-monitor.service", "w") as f:
            f.write(service_config)
            
    def _setup_linux_service(self):
        """配置Linux系统服务"""
        service_content = """
        [Unit]
        Description=SVN Monitor Service
        After=network.target
        
        [Service]
        Type=simple
        ExecStart=/usr/bin/python3 {target_dir}/src/svn_monitor.py
        WorkingDirectory={target_dir}
        Restart=always
        User=svnmonitor
        
        [Install]
        WantedBy=multi-user.target
        """.format(target_dir=self.target_dir)
        
        with open("/etc/systemd/system/svn-monitor.service", "w") as f:
            f.write(service_content)
            
        subprocess.run(["systemctl", "daemon-reload"], check=True)
        subprocess.run(["systemctl", "enable", "svn-monitor"], check=True)
```

#### 7.3.2 配置管理脚本
```python
# config_manager.py - 配置管理脚本
import pandas as pd
from pathlib import Path

class ConfigManager:
    def __init__(self, config_dir):
        self.config_dir = Path(config_dir)
        self.config_file = self.config_dir / "svn_monitor_config.xlsx"
        self.recipients_file = self.config_dir / "recipients.xlsx"
        
    def validate_config(self):
        """验证配置文件"""
        if not self.config_file.exists():
            raise FileNotFoundError("配置文件不存在")
            
        # 加载Excel配置文件
        config_df = pd.read_excel(self.config_file, sheet_name='Repository Configs')
        global_df = pd.read_excel(self.config_file, sheet_name='Global Configs')
        
        # 验证必要配置项
        required_fields = ['repository_path', 'repository_name', 'check_interval']
        for field in required_fields:
            if field not in config_df.columns:
                raise ValueError(f"缺少必要配置项: {field}")
                
    def load_recipients(self):
        """加载收件人配置"""
        if not self.recipients_file.exists():
            return []
            
        df = pd.read_excel(self.recipients_file)
        return df.to_dict('records')
        
    def backup_config(self):
        """备份配置文件"""
        backup_dir = self.config_dir / "backup"
        backup_dir.mkdir(exist_ok=True)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_file = backup_dir / f"config_backup_{timestamp}.xlsx"
        
        shutil.copy2(self.config_file, backup_file)
        return backup_file
```

### 7.4 容器化部署

#### Dockerfile
```dockerfile
FROM python:3.8-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY src/ ./src/
COPY config/ ./config/
COPY scripts/ ./scripts/

CMD ["python", "src/svn_monitor.py"]
```

#### docker-compose.yml
```yaml
version: '3.8'
services:
  svn-monitor:
    build: .
    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
    environment:
      - DEBUG=false
      - LOG_LEVEL=INFO
```

### 7.5 持续集成

#### GitHub Actions配置
```yaml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Run tests
      run: pytest --cov=src
```

## 8. 故障排查

### 8.1 常见问题

#### 配置问题
```python
# 检查配置加载
try:
    config = load_config()
except ConfigError as e:
    logger.error("配置加载失败: %s", e)
    # 使用默认配置继续运行
    config = get_default_config()
```

#### 网络问题
```python
import requests

def check_network():
    """检查网络连接"""
    try:
        response = requests.get("http://www.google.com", timeout=5)
        return response.status_code == 200
    except requests.RequestException:
        return False
```

### 8.2 性能监控

#### 添加性能监控
```python
import time
from functools import wraps

def timer(func):
    """函数执行时间监控"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        logger.info("函数 %s 执行时间: %.2f秒", func.__name__, end - start)
        return result
    return wrapper
```

## 9. 版本管理

### 9.1 Git工作流

#### 分支策略
- **main**：主分支，稳定版本
- **develop**：开发分支
- **feature/**：功能分支
- **hotfix/**：热修复分支

#### 提交规范
```bash
# 提交信息格式
feat: 添加新的监控功能
fix: 修复邮件发送问题
docs: 更新使用文档
test: 添加单元测试
```

### 9.2 版本发布

#### 版本号规范
- **主版本号**：不兼容的API修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

#### 发布流程
1. 更新版本号
2. 更新CHANGELOG.md
3. 创建发布标签
4. 构建发布包

---
*本文档为SVN监控系统的开发人员手册，包含开发环境搭建、代码规范、测试开发等内容。*