# SVN监控脚本部署指南

## 概述

本文档提供SVN监控脚本的完整部署指南，包括常规部署和SVN钩子部署两种方式。

## 环境要求

### 系统要求

- **操作系统**：Windows Server 2008 R2+ / Linux (Ubuntu 16.04+ / CentOS 7+)
- **Python版本**：Python 3.7或更高版本
- **SVN客户端**：Subversion 1.8或更高版本
- **邮件服务器**：支持SMTP协议的邮件服务器

### 软件依赖

```bash
# Python依赖包
pip install pandas
```

## 常规部署方式

### Windows服务器部署

#### 1. 环境准备

1. **安装Python 3.7+**
   - 下载并安装Python 3.7或更高版本
   - 确保Python已添加到系统PATH环境变量

2. **安装SVN客户端**
   - 安装TortoiseSVN或VisualSVN Server
   - 验证SVN命令可用性：`svn --version`

3. **配置邮件服务器访问**
   - 确保邮件服务器允许SMTP连接
   - 获取SMTP服务器地址、端口和认证信息

#### 2. 脚本部署

1. **复制项目文件**
   ```bash
   # 将项目文件复制到服务器
   xcopy snake\\*.* C:\\SVNMonitor\\ /E /I
   ```

2. **修改配置文件**
   - 系统会自动创建默认的Excel配置文件
   - 如需手动配置，可编辑 `config/svn_monitor_config.xlsx` 文件
   - 配置SVN仓库路径和邮件服务器参数

3. **测试脚本运行**
   ```cmd
   cd C:\SVNMonitor\src
   python svn_monitor.py --test
   ```

#### 3. 自动启动配置

1. **使用Windows任务计划程序**
   - 打开"任务计划程序"
   - 创建基本任务
   - 设置触发器（每5分钟执行）
   - 配置操作：启动程序 `python.exe`
   - 参数：`C:\SVNMonitor\src\svn_monitor.py`

2. **使用批处理文件**
   ```batch
   @echo off
   cd /d C:\SVNMonitor\src
   python svn_monitor.py
   ```

### Linux/Unix服务器部署

#### 1. 环境准备

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3 python3-pip subversion

# CentOS/RHEL
sudo yum update
sudo yum install python3 python3-pip subversion

# 安装Python依赖
pip3 install pandas
```

#### 2. 脚本部署

1. **复制项目文件**
   ```bash
   # 使用SCP复制文件
   scp -r snake/ user@server:/opt/svn_monitor/
   
   # 设置执行权限
   chmod +x /opt/svn_monitor/src/svn_monitor.py
   ```

2. **修改配置文件**
   ```bash
   cd /opt/svn_monitor/config
   # 系统会自动创建默认的Excel配置文件
   # 如需手动配置，可编辑svn_monitor_config.xlsx文件
   ```

#### 3. 定时任务配置

```bash
# 编辑crontab
crontab -e

# 添加定时任务（每5分钟执行一次）
*/5 * * * * /usr/bin/python3 /opt/svn_monitor/src/svn_monitor.py

# 查看crontab日志
tail -f /var/log/cron
```

## SVN钩子部署方式

### 概述

SVN钩子部署方式利用SVN的post-commit钩子功能，在每次提交后自动触发监控脚本，实现实时通知。

### Windows环境钩子部署

#### 1. 创建post-commit钩子

1. **定位SVN仓库hooks目录**
   ```
   C:\\SVN\\Repositories\\YourRepo\\hooks\\
   ```

2. **创建post-commit.bat文件**
   ```batch
   @echo off
   set REPOS=%1
   set REV=%2
   
   "C:\\Python37\\python.exe" "C:\\SVNMonitor\\src\\svn_monitor.py" --repository "%REPOS%" --revision "%REV%"
   
   if errorlevel 1 (
       echo Post-commit hook failed >&2
       exit 1
   )
   ```

#### 2. 权限配置

1. **SVN服务账户权限**
   - 确保SVN服务账户有执行Python脚本的权限
   - 配置SVN服务账户对脚本目录的读写权限

2. **环境变量配置**
   - 确保SVN服务账户的PATH包含Python和SVN路径

#### 3. 测试钩子功能

1. **手动测试钩子**
   ```cmd
   cd C:\SVN\Repositories\YourRepo\hooks
   post-commit.bat "C:\SVN\Repositories\YourRepo" 123
   ```

2. **验证提交触发**
   - 在SVN仓库中提交一个测试文件
   - 检查是否收到邮件通知

### Linux环境钩子部署

#### 1. 创建post-commit钩子

1. **定位SVN仓库hooks目录**
   ```bash
   cd /var/svn/repositories/YourRepo/hooks
   ```

2. **创建post-commit文件**
   ```bash
   #!/bin/bash
   
   REPOS="$1"
   REV="$2"
   
   # 执行监控脚本
   /usr/bin/python3 /opt/svn_monitor/src/svn_monitor.py --repository "$REPOS" --revision "$REV"
   
   # 检查执行结果
   if [ $? -ne 0 ]; then
       echo "Post-commit hook failed" >&2
       exit 1
   fi
   ```

3. **设置执行权限**
   ```bash
   chmod +x post-commit
   chown svn:svn post-commit
   ```

#### 2. 权限配置

1. **SVN用户权限**
   ```bash
   # 确保SVN用户有执行权限
   chown -R svn:svn /opt/svn_monitor/
   chmod -R 755 /opt/svn_monitor/src/
   ```

2. **Python环境配置**
   - 确保SVN用户可以访问Python解释器
   - 配置SVN用户的PATH环境变量

#### 3. SELinux配置（如启用）

```bash
# 检查SELinux状态
sestatus

# 如果启用，配置SVN钩子执行权限
setsebool -P httpd_execmem on
chcon -t httpd_exec_t /opt/svn_monitor/src/svn_monitor.py
```

## 配置详解

### 主配置文件 (svn_monitor_config.xlsx)

SVN监控系统使用Excel格式的配置文件，包含以下工作表：

**Repository Configs工作表**（仓库配置）：
- Repository ID：仓库标识符
- Repository Name：仓库名称
- Repository Path：SVN仓库路径
- URL：仓库URL
- Username：用户名
- Password：密码
- Check Interval：检查间隔（秒）
- Local Working Copy：本地工作副本路径
- Notify On Changes：是否通知变更
- Recipients：收件人列表

**Global Configs工作表**（全局配置）：
- Section：配置节（如EMAIL、LOGGING、SYSTEM）
- Key：配置键
- Value：配置值

系统首次运行时会自动创建默认的Excel配置文件模板。

### 收件人配置文件 (recipients.xlsx)

Excel文件应包含以下列：
- `name`：收件人姓名
- `email`：收件人邮箱地址
- `repository`：关联的仓库名称（支持通配符"*"）

## 故障排除

### 常见问题及解决方案

#### 1. SVN命令执行失败

**症状**：脚本无法执行SVN命令

**解决方案**：
- 检查SVN客户端是否安装：`svn --version`
- 验证仓库路径权限：确保脚本用户有访问权限
- 查看详细错误日志：`tail -f logs/svn_monitor.log`

#### 2. 邮件发送失败

**症状**：提交后未收到邮件通知

**解决方案**：
- 检查邮件服务器配置：SMTP地址、端口、认证信息
- 验证发件人账户权限：确保允许SMTP发送
- 测试网络连接：`telnet smtp.server.com 587`

#### 3. 钩子执行失败

**症状**：SVN提交后钩子未触发

**解决方案**：
- 检查钩子文件权限：确保有执行权限
- 验证钩子文件路径：确认路径正确
- 查看SVN日志：`tail -f /var/log/svn/svn.log`

#### 4. 权限问题

**症状**：脚本无法访问文件或目录

**解决方案**：
- 检查文件权限：`ls -la /path/to/file`
- 验证用户权限：确保执行用户有足够权限
- 配置SELinux策略（如适用）

### 日志分析

脚本会生成详细的日志文件，位置取决于配置：

```bash
# 查看实时日志
tail -f logs/svn_monitor.log

# 搜索错误信息
grep -i error logs/svn_monitor.log

# 查看特定仓库的日志
grep "仓库名称" logs/svn_monitor.log
```

### 性能优化建议

1. **调整监控间隔**：根据实际需求调整`check_interval`
2. **优化日志级别**：生产环境使用`INFO`级别
3. **定期清理日志**：配置日志轮转策略
4. **监控资源使用**：定期检查CPU和内存使用情况

## 维护指南

### 日常维护

1. **定期检查日志**：确保脚本正常运行
2. **更新配置文件**：根据需要调整配置参数
3. **备份配置**：定期备份重要配置文件

### 版本升级

1. **备份现有配置**
2. **停止监控服务**
3. **更新脚本文件**
4. **测试新版本功能**
5. **重新启动服务**

### 监控指标

- 脚本运行状态
- 邮件发送成功率
- SVN命令执行时间
- 系统资源使用情况

---

*最后更新：2024年*