# SVN监控系统 - 代码注释文档

## 1. 代码注释规范

### 1.1 注释原则
- **清晰明了**：注释应该简洁、准确地描述代码功能
- **及时更新**：代码修改时同步更新相关注释
- **适度注释**：避免过度注释，重点注释复杂逻辑和关键算法
- **中英文结合**：主要使用中文注释，关键术语可使用英文

### 1.2 注释类型

#### 文件头注释
```python
"""
SVN监控系统 - 主监控模块

模块功能：
- 监控SVN仓库的提交活动
- 检测版本号变化
- 触发邮件通知

作者：开发团队
创建时间：2024-01-01
版本：1.0.0
"""
```

#### 类注释
```python
class SVNMonitor:
    """
    SVN仓库监控器
    
    主要功能：
    1. 定期检查SVN仓库状态
    2. 检测提交变更
    3. 管理监控任务
    
    属性：
        config: 监控配置字典
        repositories: 监控的仓库列表
        logger: 日志记录器实例
    """
    
    def __init__(self, config: dict):
        """初始化监控器"""
        self.config = config
        self.repositories = []
        self.logger = logging.getLogger(__name__)
```

#### 函数注释
```python
def check_repository(self, repo_config: dict) -> bool:
    """
    检查单个SVN仓库的提交状态
    
    参数：
        repo_config: 仓库配置信息
            - path: SVN仓库路径
            - last_revision: 上次检查的版本号
            
    返回值：
        bool: 是否检测到新提交
        
    异常：
        SVNConnectionError: SVN连接失败时抛出
        ConfigError: 配置错误时抛出
    """
    # 实现代码...
```

#### 行内注释
```python
# 获取当前版本号，如果获取失败则使用默认值
current_revision = self.get_current_revision(repo_path) or 0

# 检查版本号是否发生变化（避免重复通知）
if current_revision > last_revision:
    # 检测到新提交，准备发送通知
    self.handle_new_commit(repo_config, current_revision)
```

## 2. 核心模块注释详解

### 2.1 主监控模块 (svn_monitor.py)

#### 主函数注释
```python
def main():
    """
    程序主入口函数
    
    执行流程：
    1. 加载配置文件
    2. 初始化监控器
    3. 启动监控循环
    4. 处理异常和退出
    
    命令行参数：
        --config: 指定配置文件路径
        --interval: 设置监控间隔（秒）
        --debug: 启用调试模式
    """
    try:
        # 解析命令行参数
        args = parse_arguments()
        
        # 加载配置文件
        config = load_config(args.config)
        
        # 创建监控器实例
        monitor = SVNMonitor(config)
        
        # 启动监控循环
        monitor.start()
        
    except KeyboardInterrupt:
        # 用户中断，正常退出
        print("监控程序已停止")
    except Exception as e:
        # 处理未预期异常
        logging.error("程序运行异常: %s", e)
        sys.exit(1)
```

#### 配置加载函数
```python
def load_config(config_path: str) -> dict:
    """
    加载和解析配置文件
    
    支持的文件格式：
    - Excel文件 (.xlsx)
    
    配置文件结构：
    {
        "repositories": [仓库配置列表],
        "mail": 邮件服务器配置,
        "system": 系统运行配置
    }
    
    参数：
        config_path: 配置文件路径
        
    返回值：
        dict: 解析后的配置字典
        
    异常：
        FileNotFoundError: 配置文件不存在
        ConfigParseError: 配置文件解析失败
    """
    # 检查文件是否存在
    if not os.path.exists(config_path):
        raise FileNotFoundError(f"配置文件不存在: {config_path}")
    
    # 根据文件扩展名选择解析器
    if config_path.endswith('.xlsx'):
        return parse_excel_config(config_path)
    else:
        raise ConfigParseError("不支持的配置文件格式")
```

### 2.2 监控模块 (monitor.py)

#### 监控器类注释
```python
class RepositoryMonitor:
    """
    单个SVN仓库监控器
    
    职责：
    - 监控指定SVN仓库的提交活动
    - 维护仓库状态信息
    - 触发变更通知
    
    状态管理：
    - last_checked: 上次检查时间
    - current_revision: 当前版本号
    - last_revision: 上次检测到的版本号
    - error_count: 连续错误次数
    """
    
    def __init__(self, repo_config: dict):
        """
        初始化仓库监控器
        
        参数：
            repo_config: 仓库配置信息
                - name: 仓库名称
                - path: 仓库路径
                - check_interval: 检查间隔（秒）
                - recipients: 收件人列表
        """
        self.name = repo_config.get('name', '未知仓库')
        self.path = repo_config['path']
        self.check_interval = repo_config.get('check_interval', 30)
        self.recipients = repo_config.get('recipients', [])
        
        # 初始化状态变量
        self.last_checked = None
        self.current_revision = 0
        self.last_revision = 0
        self.error_count = 0
        
        self.logger = logging.getLogger(f"monitor.{self.name}")
```

#### 版本检测方法
```python
def detect_changes(self) -> bool:
    """
    检测SVN仓库的变更
    
    检测逻辑：
    1. 获取当前最新版本号
    2. 与上次记录的版本号比较
    3. 如果版本号增加，表示有新提交
    4. 记录检测结果和错误计数
    
    返回值：
        bool: 是否检测到变更
        
    注意：
        - 连续错误超过阈值会暂停监控
        - 成功检测后会重置错误计数
    """
    try:
        # 获取当前版本号
        current_rev = self.get_latest_revision()
        
        # 更新检测时间
        self.last_checked = datetime.now()
        
        # 检查版本号变化
        if current_rev > self.last_revision:
            self.logger.info("检测到新提交: %s -> %s", 
                           self.last_revision, current_rev)
            self.last_revision = current_rev
            return True
        
        # 重置错误计数（检测成功）
        self.error_count = 0
        return False
        
    except SVNError as e:
        # SVN操作错误，增加错误计数
        self.error_count += 1
        self.logger.error("SVN检测错误 (%s): %s", self.error_count, e)
        
        # 错误次数超过阈值，暂停监控
        if self.error_count >= self.MAX_ERROR_COUNT:
            self.logger.warning("错误次数过多，暂停监控仓库: %s", self.name)
        
        return False
```

### 2.3 邮件模块 (mailer.py)

#### 邮件发送器类
```python
class EmailSender:
    """
    邮件通知发送器
    
    功能特性：
    - 支持SMTP协议发送邮件
    - 支持TLS/SSL加密连接
    - 邮件模板渲染
    - 发送状态跟踪
    
    配置要求：
    - smtp_server: SMTP服务器地址
    - port: 端口号（默认587）
    - username: 发件人邮箱
    - password: 邮箱密码/授权码
    - use_tls: 是否使用TLS加密
    """
    
    def __init__(self, mail_config: dict):
        """初始化邮件发送器"""
        self.smtp_server = mail_config['smtp_server']
        self.port = mail_config.get('port', 587)
        self.username = mail_config['username']
        self.password = mail_config['password']
        self.use_tls = mail_config.get('use_tls', True)
        
        # 创建SMTP连接池
        self.connection_pool = ConnectionPool(
            max_size=5,
            timeout=30
        )
        
        self.logger = logging.getLogger("mailer")
```

#### 邮件发送方法
```python
def send_notification(self, commit_info: dict, recipients: list) -> bool:
    """
    发送SVN提交通知邮件
    
    邮件内容组成：
    - 主题：包含仓库名和版本号
    - 正文：提交详细信息
    - 附件：可选的文件变更列表
    
    参数：
        commit_info: 提交信息字典
            - repository: 仓库名称
            - revision: 版本号
            - author: 提交者
            - message: 提交信息
            - changed_files: 变更文件列表
            
        recipients: 收件人邮箱列表
        
    返回值：
        bool: 邮件发送是否成功
        
    异常：
        SMTPConnectionError: SMTP连接失败
        MailSendError: 邮件发送失败
    """
    try:
        # 创建邮件消息
        msg = self.create_email_message(commit_info, recipients)
        
        # 获取SMTP连接
        with self.connection_pool.get_connection() as smtp:
            # 发送邮件
            smtp.send_message(msg)
            
        self.logger.info("邮件发送成功: %s@r%s", 
                       commit_info['repository'], commit_info['revision'])
        return True
        
    except smtplib.SMTPException as e:
        self.logger.error("邮件发送失败: %s", e)
        raise MailSendError(f"邮件发送失败: {e}")
```

## 3. 工具函数注释

### 3.1 文件操作工具
```python
def ensure_directory(path: str) -> bool:
    """
    确保目录存在，如果不存在则创建
    
    参数：
        path: 目录路径
        
    返回值：
        bool: 目录是否存在或创建成功
        
    注意：
        - 支持递归创建多级目录
        - 会设置适当的目录权限
    """
    try:
        os.makedirs(path, exist_ok=True)
        # 设置目录权限（仅限Unix系统）
        if os.name != 'nt':  # 非Windows系统
            os.chmod(path, 0o755)
        return True
    except OSError as e:
        logging.error("创建目录失败 %s: %s", path, e)
        return False
```

### 3.2 SVN操作工具
```python
def get_svn_info(repo_path: str) -> dict:
    """
    获取SVN仓库的基本信息
    
    使用svn info命令获取信息：
    - 最新版本号
    - 仓库URL
    - 最后提交信息
    
    参数：
        repo_path: SVN仓库路径（URL或本地路径）
        
    返回值：
        dict: SVN仓库信息字典
        
    异常：
        SVNCommandError: svn命令执行失败
    """
    try:
        # 执行svn info命令
        result = subprocess.run(
            ['svn', 'info', repo_path],
            capture_output=True,
            text=True,
            timeout=30
        )
        
        if result.returncode != 0:
            raise SVNCommandError(f"svn info失败: {result.stderr}")
        
        # 解析命令输出
        info = {}
        for line in result.stdout.split('\n'):
            if ':' in line:
                key, value = line.split(':', 1)
                info[key.strip()] = value.strip()
        
        return info
        
    except subprocess.TimeoutExpired:
        raise SVNCommandError("svn info命令执行超时")
```

## 4. 异常处理注释

### 4.1 自定义异常类
```python
class SVNMonitorError(Exception):
    """SVN监控系统基础异常类"""
    pass

class ConfigError(SVNMonitorError):
    """配置相关异常"""
    def __init__(self, message: str, config_path: str = None):
        super().__init__(message)
        self.config_path = config_path

class SVNConnectionError(SVNMonitorError):
    """SVN连接异常"""
    def __init__(self, message: str, repo_path: str = None):
        super().__init__(message)
        self.repo_path = repo_path

class MailSendError(SVNMonitorError):
    """邮件发送异常"""
    def __init__(self, message: str, recipient: str = None):
        super().__init__(message)
        self.recipient = recipient
```

### 4.2 异常处理示例
```python
def safe_monitor_operation(func):
    """
    监控操作的安全包装器
    
    功能：
    - 捕获并记录异常
    - 防止异常传播导致监控中断
    - 提供重试机制
    
    使用装饰器模式：
    @safe_monitor_operation
    def monitor_function():
        pass
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except SVNMonitorError as e:
            # 记录已知异常
            logging.warning("监控操作异常: %s", e)
            return None
        except Exception as e:
            # 记录未知异常
            logging.error("未预期的监控异常: %s", e)
            return None
    return wrapper
```

## 5. 配置参数注释

### 5.1 系统配置参数
```python
# 监控间隔（秒） - 控制检查频率
CHECK_INTERVAL = 30

# 最大错误次数 - 连续错误超过此值暂停监控
MAX_ERROR_COUNT = 5

# 连接超时时间（秒） - SVN操作超时设置
CONNECTION_TIMEOUT = 30

# 重试次数 - 失败操作的重试次数
MAX_RETRY_COUNT = 3

# 日志级别 - 控制日志输出详细程度
LOG_LEVEL = "INFO"
```

### 5.2 邮件模板参数
```python
# 邮件主题模板
EMAIL_SUBJECT_TEMPLATE = "[SVN监控] {repository} 有新提交 (版本{revision})"

# 邮件正文模板
EMAIL_BODY_TEMPLATE = """
仓库：{repository}
版本：{revision}
作者：{author}
时间：{timestamp}
提交信息：{message}

变更文件：
{changed_files}
"""
```

## 6. 测试代码注释

### 6.1 单元测试注释
```python
class TestSVNMonitor(unittest.TestCase):
    """SVNMonitor类的单元测试"""
    
    def setUp(self):
        """测试前置设置"""
        # 创建测试配置
        self.test_config = {
            'repositories': [
                {'name': 'test-repo', 'path': 'http://test.svn/repo'}
            ]
        }
        
        # 创建监控器实例
        self.monitor = SVNMonitor(self.test_config)
    
    def test_detect_changes(self):
        """测试变更检测功能"""
        # 模拟SVN返回版本号
        with patch('modules.monitor.get_latest_revision') as mock_rev:
            mock_rev.return_value = 100
            
            # 执行检测
            result = self.monitor.detect_changes()
            
            # 验证结果
            self.assertTrue(result)
            self.assertEqual(self.monitor.last_revision, 100)
```

---
*本文档详细说明了SVN监控系统的代码注释规范和具体实现，帮助开发人员理解和维护代码。*